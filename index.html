<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Captura las Mariposas</title>
<style>
:root{
  --bg:#0f0b12;
  --card:rgba(20,10,30,.6);
  --accent:#8b5cf6;
  --accent-2:#b084ff;
  --hud:rgba(255,255,255,.92);
  --butterfly-shadow:0 6px 18px rgba(139,92,246,.22);
  --modal-bg:rgba(15,9,20,.6);
  --particle:rgba(176,140,255,.14);
  --panel-radius:14px;
  --logo-gradient: linear-gradient(135deg,var(--accent),var(--accent-2));
}

/* Theme: aurora (default) */
.theme-aurora{
  --bg:linear-gradient(180deg,#0b0710 0%, #25102b 60%);
  --card:rgba(28,10,36,.55);
  --accent:#9b57ff;
  --accent-2:#d6b3ff;
  --hud:rgba(255,249,255,.95);
  --modal-bg:rgba(22,8,30,.56);
  --particle:rgba(188,160,255,.12);
  --butterfly-shadow:0 10px 24px rgba(155,87,255,.22);
  --logo-gradient: linear-gradient(135deg,#9b57ff,#d6b3ff);
}

/* Theme: night (high contrast dark) */
.theme-night{
  --bg:linear-gradient(180deg,#03040a 0%, #0b1020 70%);
  --card:rgba(10,12,22,.8);
  --accent:#3dd3ff;
  --accent-2:#37a6ff;
  --hud:rgba(230,245,255,.96);
  --modal-bg:rgba(6,8,16,.78);
  --particle:rgba(60,170,255,.10);
  --butterfly-shadow:0 10px 28px rgba(40,140,220,.18);
  --logo-gradient: linear-gradient(135deg,#3dd3ff,#37a6ff);
}

/* Theme: sunset (warm) */
.theme-sunset{
  --bg:linear-gradient(180deg,#2b0710 0%, #3a151c 70%);
  --card:rgba(40,14,22,.68);
  --accent:#ff6b6b;
  --accent-2:#ffb86b;
  --hud:rgba(255,250,245,.95);
  --modal-bg:rgba(40,14,22,.7);
  --particle:rgba(255,140,120,.08);
  --butterfly-shadow:0 10px 26px rgba(255,120,90,.16);
  --logo-gradient: linear-gradient(135deg,#ff6b6b,#ffb86b);
}

/* Theme: pastel (lightish) */
.theme-pastel{
  --bg:linear-gradient(180deg,#fff7fb 0%, #f2f6ff 100%);
  --card:rgba(255,255,255,.88);
  --accent:#b997ff;
  --accent-2:#9bd1ff;
  --hud:rgba(18,18,20,.92);
  --modal-bg:rgba(255,255,255,.94);
  --particle:rgba(150,170,255,.06);
  --butterfly-shadow:0 10px 30px rgba(120,120,180,.06);
  --logo-gradient: linear-gradient(135deg,#b997ff,#9bd1ff);
}

/* ==========================
  Base / Layout (kept + minor tweaks)
  ========================== */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
body{background:var(--bg);color:var(--hud);overflow:hidden;-webkit-font-smoothing:antialiased}
.app{position:relative;min-height:100vh;display:flex;flex-direction:column;gap:12px;padding:14px}

/* Topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:60}
.title{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:var(--logo-gradient);box-shadow:var(--butterfly-shadow);display:grid;place-items:center;font-weight:700;color:#fff;font-size:16px}
.logo svg{width:36px;height:36px}
.title h1{font-size:18px;margin:0}
.title .subtitle{font-size:12px;opacity:.85;margin-top:3px;line-height:1.1}
.badge-next{font-size:11px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.05);margin-left:8px;font-weight:700}

/* Controls */
.controls{display:flex;gap:10px;align-items:center}
button.btn{background:var(--card);color:var(--hud);border:1px solid rgba(255,255,255,.04);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;backdrop-filter:blur(6px);transition:all .16s}
button.btn:active{transform:translateY(1px)}
button.icon{padding:8px;border-radius:10px;display:inline-grid;place-items:center;min-width:44px}

/* Hamburger (mobile) - stacked */
.hamburger{display:none;border:0;background:transparent;cursor:pointer;padding:8px;border-radius:10px;align-items:center}
.hamburger{ /* ensure column stacking when visible */
  display:inline-flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:6px;
  width:46px;
  height:46px;
}
.hamburger .bar{width:22px;height:2px;background:var(--hud);border-radius:2px;display:block;transition:transform .22s, opacity .18s}
.hamburger.open .bar:nth-child(1){transform:translateY(6px) rotate(45deg)}
.hamburger.open .bar:nth-child(2){opacity:0}
.hamburger.open .bar:nth-child(3){transform:translateY(-6px) rotate(-45deg)}

/* Mobile slide panel */
.mobileMenu{
  position:fixed;right:16px;top:12px;background:transparent;padding:0;border-radius:12px;z-index:180;min-width:240px;
  transform:translateX(110%); transition:transform .28s cubic-bezier(.22,.9,.32,1);
}
.mobileMenu.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);border:1px solid rgba(255,255,255,0.04)}
.mobileMenu.open{transform:translateX(0)}

/* HUD */
.hud{position:absolute;right:18px;top:90px;z-index:60;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.hud .panel{background:var(--card);padding:8px 12px;border-radius:10px;font-weight:700;min-width:140px;display:flex;flex-direction:column;gap:6px}
.level-row{display:flex;align-items:center;gap:8px}
.level-bar{height:8px;width:120px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden}
.level-progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .28s cubic-bezier(.2,.9,.3,1)}

/* Stage */
.stage{position:relative;flex:1;border-radius:14px;overflow:hidden;margin-top:8px;box-shadow:inset 0 0 120px rgba(0,0,0,.2);background:transparent; min-height: calc(100vh - 180px); }
.particle{position:absolute;bottom:-10px;border-radius:50%;opacity:.9;pointer-events:none;animation:rise linear infinite}
@keyframes rise{to{transform:translateY(-120vh);opacity:0}}

/* Butterfly */
.butterfly{position:absolute;left:0;top:0;transform-origin:center center;pointer-events:auto;width:48px;height:48px;display:block;z-index:30;filter:drop-shadow(var(--butterfly-shadow));transition:transform .12s ease}
.butterfly .wing{position:absolute;width:56%;height:60%;top:4%;border-radius:60% 40% 60% 40%/70% 40% 60% 45%;opacity:0.98;transform-origin:10% 50%}
.butterfly .wing.left{left:0;background:linear-gradient(135deg,var(--accent),transparent);transform-origin:right 50%}
.butterfly .wing.right{right:0;background:linear-gradient(-135deg,var(--accent-2),transparent);transform-origin:left 50%}
.butterfly .body{position:absolute;left:50%;top:12%;transform:translateX(-50%);width:10%;height:80%;background:rgba(255,255,255,.06);border-radius:8px}
@keyframes flapL{0%{transform:rotate(8deg)}50%{transform:rotate(-20deg)}100%{transform:rotate(8deg)}}
@keyframes flapR{0%{transform:rotate(-8deg)}50%{transform:rotate(20deg)}100%{transform:rotate(-8deg)}}
.butterfly .wing.left{animation:flapL 900ms ease-in-out infinite}
.butterfly .wing.right{animation:flapR 900ms ease-in-out infinite}

/* Capture anim */
.pop-out{animation:pop .28s ease forwards}
@keyframes pop{to{transform:scale(.2);opacity:0;filter:blur(1px)}}

/* Floating message */
.floating-msg{position:fixed;left:50%;transform:translateX(-50%);bottom:8vh;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.02));padding:10px 16px;border-radius:999px;font-weight:700;opacity:0;pointer-events:none;z-index:120;box-shadow:0 6px 30px rgba(0,0,0,.38)}
.floating-msg.show{animation:floatUp 2.1s ease forwards}
@keyframes floatUp{0%{transform:translate(-50%,18px);opacity:0}10%{opacity:1}70%{transform:translate(-50%,-60px);opacity:.95}100%{transform:translate(-50%,-110px);opacity:0}}

/* Modal & Theme modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:200}
.modal-backdrop.show{display:flex}
.modal{width:min(920px,94%);max-height:86vh;overflow:auto;background:var(--modal-bg);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);box-shadow:0 20px 50px rgba(0,0,0,.6);transform:translateY(18px);opacity:0}
.modal.show{animation:modalIn .28s cubic-bezier(.16,.9,.3,1) forwards}
@keyframes modalIn{to{opacity:1;transform:none}}

/* Theme modal specific styles */
.theme-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px}
.theme-card{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:10px;display:flex;flex-direction:column;gap:8px;align-items:stretch}
.theme-preview{height:86px;border-radius:8px;box-shadow:inset 0 -10px 20px rgba(0,0,0,0.08)}
.theme-actions{display:flex;gap:8px;align-items:center;justify-content:space-between}
.small{font-size:12px;opacity:.86}

/* ==========================
  DIARY & COLLECTION ‚Äî UPDATED STYLES (only visual changes)
  (These rules replace the original ones to improve mobile rendering)
  ========================== */

/* Diary list entries: keep structure but improve spacing + readable on mobile */
.diary-list{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
  margin-top:12px;
  padding-bottom:6px;
}
.entry{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
  padding:12px 14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  font-size:14px;
  line-height:1.4;
  position:relative;
  color:var(--hud);
  word-wrap:break-word;
}
.entry:before{
  content:"‚Äú";
  position:absolute;
  left:10px;
  top:6px;
  font-size:34px;
  opacity:.10;
  color:var(--hud);
}

/* Collection grid and cards: make thumbs preserve original SVG colors and stack nicely on mobile */
.collection-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
  margin-top:12px;
}

/* card layout: on desktop compact column, on larger screens allow row-like */
.collect-card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.03);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  min-height:120px;
  transition:transform .14s, box-shadow .14s;
}
.collect-card:hover{transform:translateY(-4px);box-shadow:0 12px 36px rgba(0,0,0,0.45)}

/* ensure svg thumbs aren't tinted by CSS and keep fixed size */
.collect-card > div:first-child img,
.collect-card > div:first-child svg,
.collect-card > div:first-child > svg{
  width:86px;
  height:86px;
  display:block;
  border-radius:8px;
  flex-shrink:0;
}

/* phrases area */
.collect-phrases{
  width:100%;
  margin-top:8px;
  max-height:140px;
  overflow:auto;
  padding:8px;
  border-radius:8px;
  background:rgba(255,255,255,0.02);
  font-size:13px;
  line-height:1.3;
  border:1px solid rgba(255,255,255,0.02);
}

/* compact text for counters inside cards */
.collect-card .counter{font-weight:800;margin-top:6px;font-size:13px;color:var(--hud)}

/* custom scrollbar for phrases and diary for better touch control */
.collect-phrases::-webkit-scrollbar, .diary-list::-webkit-scrollbar{height:10px;width:8px}
.collect-phrases::-webkit-scrollbar-thumb, .diary-list::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-radius:999px}
.collect-phrases::-webkit-scrollbar-track, .diary-list::-webkit-scrollbar-track{background:transparent}

/* small helper */
.muted{color:rgba(255,255,255,0.6);font-size:13px}

/* ==========================
  PREVIEW: mini-mariposas in collection cards (live visual previews)
  ========================== */

/* container for the thumb (keeps SVG fallback working) */
.collect-card .thumb{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  min-height:86px;
}

/* Renderizar una mini-mariposa que use mismas clases/animaciones in-game */
.collect-card .butterfly.preview{
  position:relative;
  width:72px;
  height:72px;
  pointer-events:none; /* no interactiva */
  transform:none !important;
  filter:none !important;
  box-shadow:none !important;
  margin:0 auto;
}

/* ajustar proporciones para el preview */
.collect-card .butterfly.preview .wing{
  width:50%;
  height:50%;
  top:10%;
}
.collect-card .butterfly.preview .body{
  width:12%;
  height:36%;
  top:24%;
}

/* colores espec√≠ficos por tipo (preview s√≥lo) */
.collect-card .butterfly.preview.gold .wing.left{ background: linear-gradient(135deg,#ffd86b,#ff9f3b); }
.collect-card .butterfly.preview.gold .wing.right{ background: linear-gradient(-135deg,#ff9f3b,#ffd86b); }

.collect-card .butterfly.preview.blue .wing.left{ background: linear-gradient(135deg,#9fb9ff,#6f9bff); }
.collect-card .butterfly.preview.blue .wing.right{ background: linear-gradient(-135deg,#6f9bff,#9fb9ff); }

.collect-card .butterfly.preview.pink .wing.left{ background: linear-gradient(135deg,#ffa3e0,#d77bff); }
.collect-card .butterfly.preview.pink .wing.right{ background: linear-gradient(-135deg,#d77bff,#ffa3e0); }

/* Forzar animaci√≥n de alas */
.collect-card .butterfly.preview .wing.left{ animation: flapL 900ms ease-in-out infinite; }
.collect-card .butterfly.preview .wing.right{ animation: flapR 900ms ease-in-out infinite; }

/* fallback sizing for existing SVG thumbnails inside card */
.collect-card > div:first-child svg,
.collect-card > div:first-child img{ max-width:86px; max-height:86px; }

/* ==========================
  Modal mobile adjustments ‚Äî keep modals accessible but full-width on mobile
  ========================== */
@media (max-width:720px){
  .modal{
    width: calc(100% - 20px);
    height: 92vh;
    max-height: 92vh;
    border-radius:12px;
    padding:12px;
    margin:0 10px;
    overflow:hidden;
  }
  .modal .modal-inner-scroll{
    height:100%;
    overflow:auto;
    padding-right:6px;
  }

  /* stack collection card content for narrow screens */
  .collect-card{
    flex-direction:row;
    align-items:flex-start;
    gap:10px;
    padding:10px;
  }
  .collect-card > div:first-child svg,
  .collect-card > div:first-child img{
    width:64px;
    height:64px;
  }
  .collect-card .meta{display:flex;flex-direction:column;align-items:flex-start}
  .collect-phrases{max-height:88px;font-size:12px;overflow:auto}

  /* diary single column */
  .diary-list{grid-template-columns:repeat(1,1fr)}
  .entry{font-size:15px;padding:12px;border-radius:10px}
  #volumePanel { display:none !important; }
}

/* Footer */
.footer{position:relative;z-index:40;display:flex;justify-content:center;padding:8px 0;color:rgba(255,255,255,0.5);font-size:13px}

/* HUD counters for special butterflies */
.hud div { margin-bottom: 4px; font-weight: bold; font-size: 14px; }
#goldCounter { color: #FFD700; }
#blueCounter { color: #6490FF; }
#pinkCounter { color: #D778FF; }

/* Mobile tweaks (kept) */
@media (max-width:720px){
  #volumePanel { display:none !important; }
  body{padding:10px}
  .butterfly{width:66px;height:66px; touch-action: manipulation;}
  .title h1{font-size:16px}
  .controls button{padding:12px 16px;border-radius:14px; font-size:14px;}
  .hud{
    right:8px;
    top:auto;
    bottom:18px;
    gap:6px;
    font-size:13px;
  }
  .hud div { font-size: 12px; margin-bottom: 2px; }
  .logo{width:48px;height:48px;font-size:14px; border-radius:10px}
  .floating-msg{font-size:14px;padding:8px 12px}
  .stage{border-radius:10px; margin-top:6px; min-height: calc(100vh - 160px); }
  .butterfly { min-width: 54px; min-height: 54px; }

  /* show hamburger on small screens */
  .hamburger{display:inline-flex}
  .controls{display:none} /* hide original controls (we expose them in mobileMenu) */
  .mobileMenu{right:10px; top:12px; min-width:220px}
}
</style>
</head>
<body>
  <div id="volumePanel" style="
  position:absolute;
  right:14px;
  top:78px;
  z-index:200;
  display:flex;
  flex-direction:column;
  gap:6px;
  width:170px;
  background:var(--card);
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
  backdrop-filter:blur(6px);
  animation:fadeInVolume .45s ease forwards;
">
  <label style="font-size:12px; opacity:.75;">Volumen M√∫sica</label>
  <input id="musicSlider" type="range" min="0" max="1" step="0.01"/>

  <label style="font-size:12px; opacity:.75;">Volumen Efectos</label>
  <input id="fxSlider" type="range" min="0" max="1" step="0.01"/>
</div>

  <div class="app" role="application" aria-label="Captura las Mariposas">
    <div class="topbar">
      <div class="title" style="align-items:center">
        <div class="logo" aria-hidden="true" title="Captura las Mariposas">
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-opacity=".95" stroke-width="1.2">
              <path d="M32 32c6-8 14-10 20-6 4 3 4 12-4 18-6 4-12 2-16-2" fill="rgba(255,255,255,0.06)"></path>
              <path d="M32 32c-6-8-14-10-20-6-4 3-4 12 4 18 6 4 12 2 16-2" fill="rgba(255,255,255,0.06)"></path>
              <circle cx="32" cy="30" r="1.6" fill="#fff"></circle>
            </g>
          </svg>
        </div>
        <div>
          <h1>Captura las Mariposas</h1>
          <div style="display:flex;align-items:center">
            <div class="subtitle">Toca para atrapar mariposas y desbloquear frases rom√°nticas.</div>
            <div class="badge-next" id="nextBadge" title="Capturas para la pr√≥xima frase">Pr√≥x frase: 5</div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <!-- hamburger (mobile) -->
        <button class="hamburger" id="menuToggle" aria-label="Abrir men√∫">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>

        <div class="controls" role="toolbar" aria-label="Controles del juego">
          <button class="btn" id="themeBtn" title="Abrir selector de temas">Cambiar Tema</button>
          <button class="btn" id="challengeBtn" title="Iniciar desaf√≠o 30s">Desaf√≠o 30s</button>
          <button class="btn" id="diaryBtn" title="Abrir diario">Diario</button>
          <button class="btn" id="collectionBtn" title="Abrir colecci√≥n">Colecci√≥n</button>
          <button class="btn" id="musicToggle" title="Reproducir/pausar m√∫sica">M√∫sica Off</button>
            <div id="volumePanel" style="
            margin-top:6px;
            display:flex;
            flex-direction:column;
            gap:6px;
            width:170px;
            opacity:0;
            animation:fadeInVolume .45s ease forwards;
          ">
            <label style="font-size:12px; opacity:.75;">Volumen M√∫sica</label>
            <input id="musicSlider" type="range" min="0" max="1" step="0.01" style="width:100%;" />

            <label style="font-size:12px; opacity:.75; margin-top:4px;">Volumen Efectos</label>
            <input id="fxSlider" type="range" min="0" max="1" step="0.01" style="width:100%;" />
          </div>
        </div>
      </div>
    </div>

    <div class="mobileMenu" id="mobileMenu" aria-hidden="true" role="menu">
      <div class="panel" id="mobilePanel"></div>
    </div>

    <div class="stage" id="stage" aria-hidden="false"></div>

    <div class="hud" id="hud" aria-live="polite">
      <div id="goldCounter"></div>
      <div id="blueCounter"></div>
      <div id="pinkCounter"></div>
      <div class="panel" id="scorePanel">Puntos: <span id="score">0</span></div>
      <div class="panel" id="levelPanel">
        Nivel: <span id="level">1</span>
        <div class="level-row">
          <div class="level-bar" aria-hidden="true"><div id="levelProgress" class="level-progress" style="width:0%"></div></div>
        </div>
      </div>
      <div class="panel" id="timerPanel" style="display:none">Tiempo: <span id="timer">30</span>s</div>
    </div>

    <div class="footer">Hecho con todo su amor y cari√±o por Axel Silva </div>
  </div>

  <div class="floating-msg" id="floatingMsg" aria-hidden="true"></div>

  <!-- Diary Modal -->
  <div class="modal-backdrop" id="diaryModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0">Diario ‚Äî Frases desbloqueadas</h2>
        <div><button class="btn" id="closeDiary">Cerrar</button></div>
      </div>
      <div class="diary-list" id="diaryList"></div>
      <div style="margin-top:12px;text-align:right"><button class="btn" id="clearDiary">Borrar Diario</button></div>
    </div>
  </div>

  <!-- Collection Modal -->
  <div class="modal-backdrop" id="collectionModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0">Colecci√≥n</h2>
        <div><button class="btn" id="closeCollection">Cerrar</button></div>
      </div>
      <p style="opacity:.7;margin-top:8px">Mariposas especiales que encontraste</p>
      <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
        <div style="font-weight:800"><span id="colCountGold">0</span></div>
        <div style="font-weight:800"><span id="colCountBlue">0</span></div>
        <div style="font-weight:800"><span id="colCountPink">0</span></div>
      </div>
      <div class="collection-grid" id="collectionGrid"></div>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="modal-backdrop" id="resultModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h2 id="resultTitle">Desaf√≠o terminado</h2>
      <p style="margin-top:6px">Puntos: <strong id="finalScore">0</strong></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="retryBtn">Reintentar</button>
        <button class="btn" id="closeResult">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- THEME Modal -->
  <div class="modal-backdrop" id="themeModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0">Temas</h2>
        <div><button class="btn" id="closeTheme">Cerrar</button></div>
      </div>
      <p class="small" style="opacity:.75;margin-top:8px">Elige un tema para la app. La selecci√≥n se guarda y se aplica inmediatamente.</p>
      <div class="theme-grid" id="themeGrid">
        <!-- JS will populate theme cards -->
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="resetTheme">Restablecer a Auroras</button>
      </div>
    </div>
  </div>

  <audio id="bgMusic" src="musica.mp3" preload="auto"></audio>
  <div id="sliderContainer">
  <div id="volumePanel">
    <label>Volumen M√∫sica</label>
    <input id="musicSlider" type="range" min="0" max="1" step="0.01">
    <label>Volumen Efectos</label>
    <input id="fxSlider" type="range" min="0" max="1" step="0.01">
  </div>
</div>

<script>
/* --------------------------
  Mantengo y extiendo funciones existentes:
  - Preview en collection cards
  - Spawn multiple butterflies per tick with variable frequency
  ---------------------------*/

/* ---------------------------
  Audio helpers (iguales)
  ---------------------------*/
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
try{ audioCtx = new AudioContext(); }catch(e){ audioCtx = null; }
let s_masterGain = audioCtx ? audioCtx.createGain() : null;
if(s_masterGain){ s_masterGain.gain.value = 0.9; s_masterGain.connect(audioCtx.destination); }
function playTone(freq, dur=0.14, type='sine', vol=0.12) {
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, audioCtx.currentTime);
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
  o.connect(g); g.connect(s_masterGain);
  o.start(); o.stop(audioCtx.currentTime + dur);
}
function soundCapture(){ playTone(780,0.18,'sine',0.12); }
function soundPop(){ playTone(420,0.12,'triangle',0.15); }
function soundUnlock(){ playTone(880,0.36,'triangle',0.14); }
function soundLevelUp(){ playTone(560,0.32,'sine',0.14); setTimeout(()=>playTone(720,0.26,'sine',0.12),70); }

/* ---------------------------
  Data & state (keep)
  ---------------------------*/
const POEMS = [
  "Eres la melod√≠a que mi coraz√≥n no sab√≠a que necesitaba.",
  "Cada mariposa que capturas me acerca m√°s a ti.",
  "Tu presencia convierte lo ordinario en extraordinario.",
  "No s√© de distancias: solo de personas que valen la espera.",
  "Cada vez que sonr√≠es, el mundo se vuelve un poco m√°s brillante.",
  "Tus ojos guardan secretos que quiero descubrir lentamente.",
  "Me has movido el mundo sin siquiera estar cerca.",
  "No prometo estrellas, pero s√≠ quedarme cuando el cielo oscurece.",
  "Tu risa encontr√≥ mis silencios y les dio direcci√≥n.",
  "En cada peque√±o detalle tuyo, hall√© una canci√≥n que no sab√≠a que necesitaba."
];

const TYPE_PHRASES = {
  gold: [
    "Eres oro en mi vida; no te cambio por nada.",
    "Tu brillo es la br√∫jula que me gu√≠a.",
    "La paz que tengo cuando est√°s cerca no cabe en palabras."
  ],
  blue: [
    "Tu calma convierte mi tormenta en mar en calma.",
    "Con cada mirada tuya el tiempo se desacelera.",
    "Eres la nota perfecta de una melod√≠a olvidada."
  ],
  pink: [
    "Hay cosas que solo se dicen con el coraz√≥n en la mano.",
    "Si volamos juntos, prometo sostener tu risa.",
    "Tus manos dibujan rutas que quiero seguir."
  ]
};

const COLLECT_IMAGES = {
  gold: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><radialGradient id='g' cx='50%' cy='40%' r='60%'><stop offset='0' stop-color='#ffd86b'/><stop offset='1' stop-color='#ff9f3b'/></radialGradient></defs><rect width='100%' height='100%' fill='transparent'/><ellipse cx='100' cy='100' rx='62' ry='44' fill='url(#g)' opacity='0.95'/></svg>",
  blue: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><radialGradient id='g' cx='50%' cy='40%' r='60%'><stop offset='0' stop-color='#9fb9ff'/><stop offset='1' stop-color='#6f9bff'/></radialGradient></defs><rect width='100%' height='100%' fill='transparent'/><ellipse cx='100' cy='100' rx='62' ry='44' fill='url(#g)' opacity='0.95'/></svg>",
  pink: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><radialGradient id='g' cx='50%' cy='40%' r='60%'><stop offset='0' stop-color='#ffa3e0'/><stop offset='1' stop-color='#d77bff'/></radialGradient></defs><rect width='100%' height='100%' fill='transparent'/><ellipse cx='100' cy='100' rx='62' ry='44' fill='url(#g)' opacity='0.95'/></svg>"
};

const stage = document.getElementById('stage');
const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');
const floatingMsg = document.getElementById('floatingMsg');
const diaryModal = document.getElementById('diaryModal');
const diaryList = document.getElementById('diaryList');
const collectionModal = document.getElementById('collectionModal');
const collectionGrid = document.getElementById('collectionGrid');
const resultModal = document.getElementById('resultModal');
const finalScoreEl = document.getElementById('finalScore');
const levelProgressEl = document.getElementById('levelProgress');
const nextBadge = document.getElementById('nextBadge');

let score = 0;
let level = 1;
let unlocked = (function(){ try{ return JSON.parse(localStorage.getItem('butterflyDiary_v2')||'[]'); }catch(e){ return []; } })();
let collection = (function(){ try{ return JSON.parse(localStorage.getItem('butterflyCollection_v1')||'{}'); }catch(e){ return {}; } })();
let collectionDetails = (function(){ try{ return JSON.parse(localStorage.getItem('butterflyCollectionDetails_v1')||'{}'); }catch(e){ return {}; } })();

let spawnTimerId = null;
let paused = false;
let challengeCountdown = null;
let challengeTimer = 30;
let butterflyCounters = { gold: 0, blue: 0, pink: 0 };
const storedCounters = JSON.parse(localStorage.getItem('butterflyCounters_v1') || 'null');
if(storedCounters) butterflyCounters = storedCounters;
document.getElementById('goldCounter').textContent = `Gold: ${butterflyCounters.gold}`;
document.getElementById('blueCounter').textContent = `Blue: ${butterflyCounters.blue}`;
document.getElementById('pinkCounter').textContent = `Pink: ${butterflyCounters.pink}`;

const butterflies = [];
const particles = [];

/* ---------------------------
  PARTICLES (kept)
  ---------------------------*/
function createParticles(count=32){
  const rect = stage.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 2 + Math.random()*4;
    p.style.width = p.style.height = size + 'px';
    p.style.left = (Math.random()*100) + '%';
    p.style.bottom = (-Math.random()*20) + 'px';
    p.style.background = getComputedStyle(document.body).getPropertyValue('--particle') || 'rgba(200,160,255,0.12)';
    p.style.animationDuration = (18 + Math.random()*36) + 's';
    p.style.opacity = (0.04 + Math.random()*0.48);
    stage.appendChild(p);
    particles.push({el:p, dur: parseFloat(p.style.animationDuration)});
  }
}
createParticles(28);

/* ---------------------------
  SPAWN logic (kept + robust guard)
  ---------------------------*/
let butterflyId = 0;
function spawnButterfly(){
  const rect = stage.getBoundingClientRect();
  // guard: if stage height is zero (race condition), retry slightly later
  if(rect.width === 0 || rect.height === 0){
    setTimeout(spawnButterfly, 120);
    return;
  }

  const b = document.createElement('div');
  b.className = 'butterfly';
  b.dataset.id = ++butterflyId;

  const scale = (0.75 + Math.random()*0.9);
  b.style.width = (48*scale) + 'px';
  b.style.height = (48*scale) + 'px';

  b.innerHTML = `<div class="wing left"></div><div class="wing right"></div><div class="body"></div>`;

  const startX = Math.random()*Math.max(80, rect.width-80);
  const startY = rect.height + 40;
  b.style.left = startX + 'px';
  b.style.top = startY + 'px';

  const r = Math.random();
  if(r < 0.03){ b.dataset.type='gold'; b.dataset.points=5; }
  else if(r < 0.09){ b.dataset.type='blue'; b.dataset.points=2; }
  else if(r < 0.16){ b.dataset.type='pink'; b.dataset.points=1; }
  else { b.dataset.type='normal'; b.dataset.points=1; }

  b.classList.add(b.dataset.type);

  const paths = ['up','zigzag','wave'];
  const path = paths[Math.floor(Math.random()*paths.length)];
  const duration = 7000 + Math.random()*9000;
  const model = {
    id: b.dataset.id,
    el: b,
    sx: startX,
    sy: startY,
    t0: performance.now(),
    duration,
    path,
    captured: false,
    scale
  };

  b.addEventListener('pointerdown', onCapture);

  stage.appendChild(b);
  butterflies.push(model);

  setTimeout(()=>{ if(b.parentNode){ b.remove(); } }, duration + 1400);
}

/* animate loop (kept) */
function animateAll(now){
  for(let i = butterflies.length - 1; i >= 0; i--){
    const m = butterflies[i];
    if(!m.el.parentNode){
      butterflies.splice(i,1);
      continue;
    }
    if(paused) { m.t0 += 0; continue; }

    const elapsed = now - m.t0;
    const p = Math.min(1, elapsed / m.duration);
    const rect = stage.getBoundingClientRect();
    const ease = easeInOutSine(p);
    let x = m.sx;
    let y = m.sy - (rect.height + 220) * ease;

    if(m.path === 'zigzag'){
      x = m.sx + Math.sin(p*Math.PI*6) * (60 + 80*p);
    } else if(m.path === 'wave'){
      x = m.sx + Math.sin(p*Math.PI*2) * 90;
      y = m.sy - (rect.height*0.9) * ease - Math.sin(p*Math.PI*4)*12;
    }

    const rot = Math.sin(p*Math.PI*2) * 12;
    m.el.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg)`;
    const bob = Math.sin(now/220 + m.sx) * 2;
    m.el.style.top = (y + bob) + 'px';

    if(p >= 1){
      if(m.el.parentNode) m.el.remove();
      butterflies.splice(i,1);
    }
  }
  requestAnimationFrame(animateAll);
}
requestAnimationFrame(animateAll);
function easeInOutSine(x){ return -(Math.cos(Math.PI*x)-1)/2; }

/* ---------------------------
  Capture handling (kept)
  ---------------------------*/
let lastSpecialRomanticAt = -1;
function onCapture(e){
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

  const el = e.currentTarget;
  if(!el || el._captured) return;
  el._captured = true;
  el.style.pointerEvents = 'none';
  el.classList.add('pop-out');
  setTimeout(()=>{ if(el.parentNode) el.remove(); }, 320);

  const pts = Number(el.dataset.points||1);
  score += pts;
  scoreEl.textContent = score;

  soundCapture(); soundPop();

  const poem = POEMS[Math.floor(Math.random()*POEMS.length)];
  showFloatingMessage(poem);

  const type = el.dataset.type || 'normal';

  if(type === 'gold'){
    butterflyCounters.gold++;
    collection.gold = true;
    const phrase = pickupTypePhrase('gold');
    if(phrase) pushUnlocked(phrase);
    saveCollectionState();
    document.getElementById('goldCounter').textContent = `Gold: ${butterflyCounters.gold}`;
    showFloatingMessage('¬°Eres incre√≠ble! ¬°Capturaste una Dorada!');
    soundUnlock();
  }

  if(type === 'blue'){
    butterflyCounters.blue++;
    const phrase = pickupTypePhrase('blue');
    if(phrase) pushUnlocked(phrase);
    saveCollectionState();
    document.getElementById('blueCounter').textContent = `Blue: ${butterflyCounters.blue}`;
    slowAllButterflies(3500);
    showFloatingMessage('Mariposa azul - El tiempo parece ralentizarse.');
  }

  if(type === 'pink'){
    butterflyCounters.pink++;
    const phrase = pickupTypePhrase('pink');
    if(phrase) pushUnlocked(phrase);
    saveCollectionState();
    document.getElementById('pinkCounter').textContent = `Pink: ${butterflyCounters.pink}`;
    showFloatingMessage("Mariposa Rosa - Hay cosas que s√≥lo se dicen cuando volamos juntos.");
    soundUnlock();
  }

  if(score % 5 === 0){
    const remaining = POEMS.filter(p => !unlocked.includes(p));
    const pick = remaining.length ? remaining[Math.floor(Math.random()*remaining.length)] : POEMS[Math.floor(Math.random()*POEMS.length)];
    pushUnlocked(pick);
    showFloatingMessage('Frase desbloqueada para tu Diario.');
    soundUnlock();
  }

  const newLevel = Math.floor(score / 10) + 1;
  if(newLevel > level){
    level = newLevel;
    levelEl.textContent = level;
    onLevelUp();
  }
  updateLevelProgress();
  updateNextBadge();

  if(score >= 20 && lastSpecialRomanticAt < 20){
    lastSpecialRomanticAt = 20;
    showFloatingMessage('‚ú® Mensaje rom√°ntico especial desbloqueado ‚Äî 20 puntos ‚ú®');
    const specialPhrase = "Cuando llegaste, el mundo cambi√≥ su color.";
    if(!unlocked.includes(specialPhrase)){ pushUnlocked(specialPhrase); }
    soundUnlock();
  }
}

/* push phrase to diary (kept) */
function pushUnlocked(phrase){
  if(!phrase) return;
  if(!unlocked.includes(phrase)) unlocked.push(phrase);
  localStorage.setItem('butterflyDiary_v2', JSON.stringify(unlocked));
  renderDiary();
}

/* per-type phrase capture (kept) */
function pickupTypePhrase(type){
  if(!TYPE_PHRASES[type]) return null;
  collectionDetails[type] = collectionDetails[type] || [];
  const available = TYPE_PHRASES[type].filter(p => !collectionDetails[type].includes(p));
  const pick = available.length ? available[Math.floor(Math.random()*available.length)] : TYPE_PHRASES[type][Math.floor(Math.random()*TYPE_PHRASES[type].length)];
  if(!collectionDetails[type].includes(pick)) collectionDetails[type].push(pick);
  localStorage.setItem('butterflyCollectionDetails_v1', JSON.stringify(collectionDetails));
  return pick;
}
function saveCollectionState(){
  localStorage.setItem('butterflyCollection_v1', JSON.stringify(collection));
  localStorage.setItem('butterflyCounters_v1', JSON.stringify(butterflyCounters));
}

/* slow, level up (kept) */
function slowAllButterflies(duration=3000){
  const list = Array.from(stage.querySelectorAll('.butterfly'));
  list.forEach(b=>{ b.style.transition = 'filter .3s, opacity .3s'; b.style.opacity = 0.78; b._slow = true; });
  setTimeout(()=>{ list.forEach(b=>{ if(b.parentNode){ b.style.opacity = 1; b._slow = false; } }); }, duration);
}
function onLevelUp(){
  soundLevelUp();
  const rate = Math.max(420, 1200 - (level-1)*80);
  startSpawning(rate);
  spawnLevelParticles();
  showFloatingMessage('¬°Nivel '+level+'!');
}
function spawnLevelParticles(){
  const burstCount = 12 + Math.floor(level*2);
  for(let i=0;i<burstCount;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 3 + Math.random()*6;
    p.style.width = p.style.height = size + 'px';
    p.style.left = (40 + Math.random()*20) + '%';
    p.style.bottom = '12%';
    p.style.background = getComputedStyle(document.body).getPropertyValue('--accent') || '#9b57ff';
    p.style.opacity = 0.95;
    p.style.animationDuration = (0.8 + Math.random()*1.2) + 's';
    stage.appendChild(p);
    setTimeout(()=>{ if(p.parentNode) p.remove(); }, 1600);
  }
}

/* floating message (kept) */
let floatTimeout = null;
function showFloatingMessage(text){
  floatingMsg.textContent = text;
  floatingMsg.classList.remove('show');
  void floatingMsg.offsetWidth;
  floatingMsg.classList.add('show');
  if(floatTimeout) clearTimeout(floatTimeout);
  floatTimeout = setTimeout(()=>{ floatingMsg.classList.remove('show'); }, 2200);
}

/* Diary & Collection rendering (adjusted renderCollection for preview only) */
document.getElementById('diaryBtn').addEventListener('click', ()=> openDiary());
document.getElementById('closeDiary').addEventListener('click', ()=> closeDiary());
document.getElementById('clearDiary').addEventListener('click', ()=>{ unlocked = []; localStorage.setItem('butterflyDiary_v2', JSON.stringify(unlocked)); renderDiary(); });

function renderDiary(){
  diaryList.innerHTML = '';
  if(unlocked.length === 0){
    diaryList.innerHTML = '<div style="opacity:.6">No hay frases desbloqueadas. Captura 5 mariposas para empezar.</div>';
    return;
  }
  unlocked.slice().reverse().forEach(p=>{
    const d = document.createElement('div'); d.className='entry'; d.textContent = p; diaryList.appendChild(d);
  });
}
function openDiary(){ renderDiary(); diaryModal.classList.add('show'); diaryModal.setAttribute('aria-hidden','false'); diaryModal.querySelector('.modal').classList.add('show'); }
function closeDiary(){ diaryModal.classList.remove('show'); diaryModal.setAttribute('aria-hidden','true'); diaryModal.querySelector('.modal').classList.remove('show'); }

document.getElementById('collectionBtn').addEventListener('click', ()=> openCollection());
document.getElementById('closeCollection').addEventListener('click', ()=> closeCollection());

/* === REPLACED renderCollection: creates a live visual preview using .butterfly.preview,
       preserves all IDs and storage behavior, only changes rendering inside the modal === */
function renderCollection(){
  collectionGrid.innerHTML = '';
  const keys = ['gold','blue','pink'];
  keys.forEach(k=>{
    const card = document.createElement('div'); card.className='collect-card';

    // THUMB wrapper
    const thumbWrap = document.createElement('div');
    thumbWrap.className = 'thumb';

    if(collection[k] || (butterflyCounters[k] && butterflyCounters[k] > 0)){
      // create a miniature "live" butterfly using same classes/animation
      const preview = document.createElement('div');
      preview.className = `butterfly preview ${k}`;
      preview.style.width = '72px';
      preview.style.height = '72px';
      preview.innerHTML = `<div class="wing left"></div><div class="wing right"></div><div class="body"></div>`;
      thumbWrap.appendChild(preview);
    } else {
      // fallback placeholder
      const placeholder = document.createElement('div');
      placeholder.style.width = '86px';
      placeholder.style.height = '86px';
      placeholder.style.display = 'grid';
      placeholder.style.placeItems = 'center';
      placeholder.style.opacity = '.35';
      placeholder.textContent = '???';
      thumbWrap.appendChild(placeholder);
    }
    card.appendChild(thumbWrap);

    // meta area (keeps layout compact)
    const metaWrap = document.createElement('div');
    metaWrap.style.display = 'flex';
    metaWrap.style.flexDirection = 'column';
    metaWrap.style.alignItems = 'center';
    metaWrap.style.width = '100%';

    const title = document.createElement('div');
    title.style.fontWeight = '800';
    title.style.marginTop = '6px';
    title.textContent = k.charAt(0).toUpperCase()+k.slice(1) + ((collection[k] || (butterflyCounters[k] && butterflyCounters[k] > 0)) ? ' ‚Äî Desbloqueada' : ' ‚Äî Bloqueada');
    metaWrap.appendChild(title);

    const cnt = document.createElement('div');
    cnt.style.fontWeight='800';
    cnt.style.marginTop='6px';
    cnt.textContent = `Capturadas: ${butterflyCounters[k] || 0}`;
    metaWrap.appendChild(cnt);

    const phrasesBox = document.createElement('div'); phrasesBox.className = 'collect-phrases';
    const list = collectionDetails[k] || [];
    if(list.length){
      list.forEach(ph=>{
        const pEl = document.createElement('div'); pEl.style.marginBottom='6px'; pEl.textContent = "‚Ä¢ " + ph; phrasesBox.appendChild(pEl);
      });
    } else {
      const em = document.createElement('div'); em.style.opacity = '.5'; em.textContent = 'Sin frases capturadas a√∫n.';
      phrasesBox.appendChild(em);
    }
    metaWrap.appendChild(phrasesBox);

    card.appendChild(metaWrap);
    collectionGrid.appendChild(card);
  });
  document.getElementById('colCountGold').textContent = butterflyCounters.gold || 0;
  document.getElementById('colCountBlue').textContent = butterflyCounters.blue || 0;
  document.getElementById('colCountPink').textContent = butterflyCounters.pink || 0;
}
function openCollection(){ renderCollection(); collectionModal.classList.add('show'); collectionModal.setAttribute('aria-hidden','false'); collectionModal.querySelector('.modal').classList.add('show'); }
function closeCollection(){ collectionModal.classList.remove('show'); collectionModal.setAttribute('aria-hidden','true'); collectionModal.querySelector('.modal').classList.remove('show'); }

/* ---------------------------
  Theme manager: available themes + modal
  ---------------------------*/
const THEMES = [
  { id: 'theme-aurora', name: 'Aurora (default)', description: 'Est√©tica p√∫rpura suave y ne√≥n.' },
  { id: 'theme-night', name: 'Noche (contraste)', description: 'Fondo oscuro, acentos azules.' },
  { id: 'theme-sunset', name: 'Atardecer', description: 'Tonos c√°lidos y dorados.' },
  { id: 'theme-pastel', name: 'Pastel', description: 'Tono claro y suave.' }
];

const themeGrid = document.getElementById('themeGrid');
const themeModal = document.getElementById('themeModal');
const closeThemeBtn = document.getElementById('closeTheme');
const resetThemeBtn = document.getElementById('resetTheme');
const themeBtn = document.getElementById('themeBtn');

function buildThemeCards(){
  themeGrid.innerHTML = '';
  THEMES.forEach(t=>{
    const card = document.createElement('div'); card.className = 'theme-card';
    const preview = document.createElement('div'); preview.className = 'theme-preview';
    // make a quick preview background that reflects the theme via inline style
    if(t.id === 'theme-aurora') preview.style.background = 'linear-gradient(180deg,#0b0710,#25102b)';
    if(t.id === 'theme-night') preview.style.background = 'linear-gradient(180deg,#03040a,#0b1020)';
    if(t.id === 'theme-sunset') preview.style.background = 'linear-gradient(180deg,#2b0710,#3a151c)';
    if(t.id === 'theme-pastel') preview.style.background = 'linear-gradient(180deg,#fff7fb,#f2f6ff)';
    preview.style.border = '1px solid rgba(255,255,255,0.04)';
    preview.style.display = 'block';
    card.appendChild(preview);

    const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = t.name; card.appendChild(title);
    const desc = document.createElement('div'); desc.className='small'; desc.textContent = t.description; card.appendChild(desc);

    const actions = document.createElement('div'); actions.className = 'theme-actions';
    const applyBtn = document.createElement('button'); applyBtn.className = 'btn'; applyBtn.textContent = 'Aplicar';
    applyBtn.addEventListener('click', ()=> { applyTheme(t.id); closeThemeModal(); });
    const previewBtn = document.createElement('button'); previewBtn.className = 'btn'; previewBtn.textContent = 'Vista';
    previewBtn.addEventListener('click', ()=> { applyTheme(t.id, {persist:false}); });
    actions.appendChild(previewBtn); actions.appendChild(applyBtn);
    card.appendChild(actions);
    themeGrid.appendChild(card);
  });
}
buildThemeCards();

function applyTheme(themeId, opts={persist:true}){
  // remove any theme-* classes
  const body = document.body;
  THEMES.forEach(t=> body.classList.remove(t.id));
  body.classList.add(themeId);
  // store
  if(opts.persist !== false) localStorage.setItem('butterflyTheme', themeId);
  // update logo gradient variable if necessary (CSS vars handle visuals)
}

/* theme modal controls */
themeBtn.addEventListener('click', ()=> openThemeModal());
closeThemeBtn.addEventListener('click', ()=> closeThemeModal());
resetThemeBtn.addEventListener('click', ()=> { applyTheme('theme-aurora'); });

function openThemeModal(){ themeModal.classList.add('show'); themeModal.setAttribute('aria-hidden','false'); themeModal.querySelector('.modal').classList.add('show'); }
function closeThemeModal(){ themeModal.classList.remove('show'); themeModal.setAttribute('aria-hidden','true'); themeModal.querySelector('.modal').classList.remove('show'); }

/* load saved theme on init (fallback to aurora) */
function loadSavedTheme(){
  const saved = localStorage.getItem('butterflyTheme');
  if(saved && THEMES.some(t=>t.id === saved)){
    applyTheme(saved);
  } else {
    applyTheme('theme-aurora');
  }
}

// intentar reproducir m√∫sica autom√°ticamente
setTimeout(async ()=>{
  try{
    await bgAudio.play();
    musicPlaying = true;
    musicToggleBtn.textContent = 'üîä M√∫sica On';
  }catch(e){
    // si falla, el usuario debe tocar la pantalla por bloqueo del navegador
  }
}, 300);


/* ---------------------------
  Challenge, music, mobile menu, spawning scheduler...
  (kept original behaviors; only small wiring around theme)
  ---------------------------*/
document.getElementById('challengeBtn').addEventListener('click', ()=> startChallenge(30));
document.getElementById('retryBtn').addEventListener('click', ()=> { closeResult(); resetAfterChallengeStart(); });
document.getElementById('closeResult').addEventListener('click', ()=> { closeResult(); resumeNormal(); });

function startChallenge(seconds=30){
  score = 0; scoreEl.textContent = '0';
  try{ unlocked = JSON.parse(localStorage.getItem('butterflyDiary_v2') || '[]') || unlocked; }catch(e){}
  level = 1; levelEl.textContent = level; updateLevelProgress();
  paused = false;
  document.getElementById('timerPanel').style.display = 'block';
  challengeTimer = seconds; document.getElementById('timer').textContent = challengeTimer;
  startSpawning(800);
  if(challengeCountdown) clearInterval(challengeCountdown);
  challengeCountdown = setInterval(()=>{
    challengeTimer--; document.getElementById('timer').textContent = challengeTimer;
    if(challengeTimer <= 0){ endChallenge(); }
  },1000);
}
function endChallenge(){
  clearInterval(challengeCountdown);
  challengeCountdown = null;
  document.getElementById('timerPanel').style.display = 'none';
  stopSpawning();
  finalScoreEl.textContent = score;
  resultModal.classList.add('show'); resultModal.setAttribute('aria-hidden','false'); resultModal.querySelector('.modal').classList.add('show');
}
function closeResult(){ resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true'); resultModal.querySelector('.modal').classList.remove('show'); }
function resetAfterChallengeStart(){ closeResult(); startSpawning(1200); document.getElementById('timerPanel').style.display = 'none'; }
function resumeNormal(){ startSpawning(1200); }

const bgAudio = document.getElementById('bgMusic');
// ===== Vol√∫menes (fijo, una sola vez) =====
const musicSlider = document.getElementById('musicSlider');
const fxSlider = document.getElementById('fxSlider');

// cargar valores guardados
musicSlider.value = localStorage.getItem('bgMusicVolume') || 0.3;
fxSlider.value = localStorage.getItem('fxVolume') || 0.9;

bgAudio.volume = Number(musicSlider.value);
if(s_masterGain) s_masterGain.gain.value = Number(fxSlider.value);

musicSlider.addEventListener('input', ()=>{
  bgAudio.volume = Number(musicSlider.value);
  localStorage.setItem('bgMusicVolume', bgAudio.volume);
});

fxSlider.addEventListener('input', ()=>{
  if(s_masterGain){
    s_masterGain.gain.value = Number(fxSlider.value);
    localStorage.setItem('fxVolume', s_masterGain.gain.value);
  }
});

let musicPlaying = false;
const musicToggleBtn = document.getElementById('musicToggle');
musicToggleBtn.textContent = 'üîá M√∫sica Off';
document.getElementById('musicToggle').addEventListener('click', async ()=>{
  if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
  try{
    if(!musicPlaying){
      await bgAudio.play();
      musicPlaying = true;
      musicToggleBtn.textContent = 'üîä M√∫sica On';
      bgAudio.onended = ()=>{ musicPlaying = false; musicToggleBtn.textContent = 'üîá M√∫sica Off'; };
    } else {
      bgAudio.pause();
      musicPlaying = false;
      musicToggleBtn.textContent = 'üîá M√∫sica Off';
    }
  }catch(e){
    showFloatingMessage('Toca la pantalla para permitir reproducci√≥n de audio.');
  }
});

/* touch prevention + pointer bridging (kept) */
document.addEventListener('touchmove', function(e){
  if(e.target.closest('#stage')) e.preventDefault();
},{passive:false});

stage.addEventListener('pointerdown', function(e){
  const b = e.target.closest('.butterfly');
  if(b) b.dispatchEvent(new Event('pointerdown',{bubbles:true,cancelable:true}));
});

/* Level progress & next badge (kept) */
function updateLevelProgress(){ const exp = score; const progressPct = ((exp % 10) / 10) * 100; levelProgressEl.style.width = progressPct + '%'; }
function updateNextBadge(){ const need = 5 - (score % 5 || 5); nextBadge.textContent = `Pr√≥x frase: ${need}`; }

/* Accessibility helpers (kept) */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(diaryModal.classList.contains('show')) closeDiary();
    if(collectionModal.classList.contains('show')) closeCollection();
    if(resultModal.classList.contains('show')) closeResult();
    if(themeModal.classList.contains('show')) closeThemeModal();
    document.getElementById('mobileMenu').classList.remove('open');
    document.getElementById('menuToggle').classList.remove('open');
  }
});

/* Mobile menu (kept) and hamburger stacking already fixed earlier */
(function buildMobileMenu() {
  const mobilePanel = document.getElementById('mobilePanel');
  const mobileButtons = [
    {label:'Cambiar Tema', target:'themeBtn'},
    {label:'Desaf√≠o 30s', target:'challengeBtn'},
    {label:'Diario', target:'diaryBtn'},
    {label:'Colecci√≥n', target:'collectionBtn'},
    {label:'M√∫sica', target:'musicToggle'}
  ];

  mobilePanel.innerHTML = '';

  // ‚õî YA NO SE CREA NADA DENTRO DEL FOR EACH
  mobileButtons.forEach(b => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.style.width = '100%';
    btn.style.textAlign = 'left';
    btn.style.padding = '10px';
    btn.style.marginBottom = '6px';
    btn.textContent = b.label;

    btn.addEventListener('click', () => {
      const orig = document.getElementById(b.target);
      if (orig) orig.click();
      closeMobileMenu();
    });

    mobilePanel.appendChild(btn);
  });

  // ‚õî SLIDERS SE CREAN UNA SOLA VEZ AQU√ç (fuera del forEach)
  const sliderContainer = document.createElement('div');
  sliderContainer.style.marginTop = '10px';
  sliderContainer.style.padding = '8px 0';

  // Volumen M√∫sica
  const musicVolLabel = document.createElement('div');
  musicVolLabel.style.margin = '6px 0 2px';
  musicVolLabel.style.fontSize = '13px';
  musicVolLabel.style.opacity = '.8';
  musicVolLabel.textContent = 'Volumen M√∫sica';

  const musicSlider = document.createElement('input');
  musicSlider.type = 'range';
  musicSlider.min = 0;
  musicSlider.max = 1;
  musicSlider.step = 0.01;
  musicSlider.value = bgAudio.volume || 0.3;
  musicSlider.style.width = '100%';
  musicSlider.addEventListener('input', () => {
    bgAudio.volume = Number(musicSlider.value);
    localStorage.setItem('bgMusicVolume', bgAudio.volume);
  });

  // Volumen Efectos
  const fxVolLabel = document.createElement('div');
  fxVolLabel.style.margin = '6px 0 2px';
  fxVolLabel.style.fontSize = '13px';
  fxVolLabel.style.opacity = '.8';
  fxVolLabel.textContent = 'Volumen Efectos';

  const fxSlider = document.createElement('input');
  fxSlider.type = 'range';
  fxSlider.min = 0;
  fxSlider.max = 1;
  fxSlider.step = 0.01;
  fxSlider.value = s_masterGain.gain.value;
  fxSlider.style.width = '100%';
  fxSlider.addEventListener('input', () => {
    s_masterGain.gain.value = Number(fxSlider.value);
    localStorage.setItem('fxVolume', s_masterGain.gain.value);
  });

  // A√±adir sliders al contenedor
  sliderContainer.appendChild(musicVolLabel);
  sliderContainer.appendChild(musicSlider);
  sliderContainer.appendChild(fxVolLabel);
  sliderContainer.appendChild(fxSlider);

  // Agregar una sola vez
  mobilePanel.appendChild(sliderContainer);

  // toggle del men√∫
  const menuToggle = document.getElementById('menuToggle');
  const mobileMenu = document.getElementById('mobileMenu');

  menuToggle.addEventListener('click', () => {
    mobileMenu.classList.toggle('open');
    menuToggle.classList.toggle('open');
  });

  document.addEventListener('click', (ev) => {
    const mroot = document.getElementById('mobileMenu');
    const toggle = document.getElementById('menuToggle');
    if (!mroot.contains(ev.target) && !toggle.contains(ev.target) && mroot.classList.contains('open')) {
      closeMobileMenu();
    }
  }, true);

  function closeMobileMenu() {
    mobileMenu.classList.remove('open');
    menuToggle.classList.remove('open');
  }
})();

/* === REPLACED spawning scheduler: now spawns multiple butterflies per tick and adapts to screen size === */
let spawnTimer = null;
function scheduleNextSpawn(rateMs = 1200){
  clearTimeout(spawnTimer);

  // add variability in interval
  const actualRate = Math.max(160, Math.round(rateMs + (Math.random()*600 - 300)));

  spawnTimer = setTimeout(()=>{
    // determine how many to spawn this tick based on width
    const w = window.innerWidth || 1024;
    let minCount = 1, maxCount = 3;
    if(w >= 1400){ minCount = 3; maxCount = 6; }
    else if(w >= 1000){ minCount = 2; maxCount = 4; }
    else if(w >= 720){ minCount = 2; maxCount = 3; }
    else { minCount = 1; maxCount = 2; } // mobile: fewer at once

    const spawnCount = Math.floor(minCount + Math.random()*(maxCount - minCount + 1));

    for(let i=0;i<spawnCount;i++){
      // stagger slightly
      setTimeout(()=>{ spawnButterfly(); }, Math.round(i * (actualRate / Math.max(3, spawnCount))));
    }

    // schedule next with slight variation
    const nextBase = Math.max(220, rateMs + (Math.random()*800 - 400));
    scheduleNextSpawn(nextBase);
  }, actualRate);
}

function startSpawning(rateMs=1200){ if(spawnTimer) clearTimeout(spawnTimer); scheduleNextSpawn(rateMs); }
function stopSpawning(){ if(spawnTimer) clearTimeout(spawnTimer); spawnTimer = null; }
function removeButterflyById(id){ for(let i=butterflies.length-1;i>=0;i--){ if(butterflies[i].id == id){ if(butterflies[i].el.parentNode) butterflies[i].el.remove(); butterflies.splice(i,1); } } }

/* Init: load theme + spawn right away + restore data (kept) */
(function init(){
  // Restaurar volumen guardado
  const svMus = localStorage.getItem('bgMusicVolume');
  if(svMus !== null) bgAudio.volume = Number(svMus);

  const svFx = localStorage.getItem('fxVolume');
  if(svFx !== null && s_masterGain) s_masterGain.gain.value = Number(svFx);

  // load saved theme (new)
  loadSavedTheme();

  document.getElementById('level').textContent = level;
  scoreEl.textContent = score;
  updateLevelProgress();
  updateNextBadge();

  // spawn a few right away so mobile users see activity immediately
  spawnButterfly();
  setTimeout(()=>spawnButterfly(), 220);
  // start regular spawning
  startSpawning(1200);

  try{ unlocked = JSON.parse(localStorage.getItem('butterflyDiary_v2')||'[]'); }catch(e){ unlocked = []; }
  try{ collection = JSON.parse(localStorage.getItem('butterflyCollection_v1')||'{}'); }catch(e){ collection = {}; }
  try{ collectionDetails = JSON.parse(localStorage.getItem('butterflyCollectionDetails_v1')||'{}'); }catch(e){ collectionDetails = {}; }

  window.addEventListener('resize', ()=>{
    const existing = stage.querySelectorAll('.particle').length;
    const want = Math.max(12, Math.min(96, Math.floor(window.innerWidth/24)));
    if(existing < want) createParticles(want - existing);
  });
  // intentar autoplay
  setTimeout(async ()=>{
    try{
      await bgAudio.play();
      musicPlaying = true;
      musicToggleBtn.textContent = 'üîä M√∫sica On';
    }catch(e){}
  }, 400);

  // fallback: primer toque desbloquea audio
  document.addEventListener('pointerdown', async ()=>{
    if(!musicPlaying){
      try{
        await bgAudio.play();
        musicPlaying = true;
        musicToggleBtn.textContent = 'üîä M√∫sica On';
      }catch(e){}
    }
  }, { once:true });
})();
// Forzar desbloqueo de audio al tocar la pantalla
document.addEventListener('pointerdown', async ()=>{
  if(!musicPlaying){
    try{
      await bgAudio.play();
      musicPlaying = true;
      musicToggleBtn.textContent = 'üîä M√∫sica On';
    }catch(e){}
  }
}, { once:true });
window.spawnButterfly = spawnButterfly;
requestAnimationFrame(animateAll);
</script>
</body>
</html>
